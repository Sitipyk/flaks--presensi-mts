<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Presensi Harian</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
  <style>
    body { 
      background-color: #f8f9fa; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .container {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: 25px;
      margin-top: 20px;
      margin-bottom: 20px;
    }

    h3 {
      color: #0056b3;
      border-bottom: 2px solid #0056b3;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }

    .btn-primary {
      background-color: #0056b3;
      border-color: #0056b3;
    }

    .btn-primary:hover {
      background-color: #004494;
      border-color: #004494;
    }

    .form-control:focus, .form-select:focus {
      border-color: #0056b3;
      box-shadow: 0 0 0 0.2rem rgba(0, 86, 179, 0.25);
    }

    .card {
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 15px;
    }

    .card-header {
      background-color: #0056b3;
      color: white;
      font-weight: 500;
    }

    video, canvas {
      max-width: 100%;
      height: auto;
      border-radius: 5px;
    }

    #video {
      width: 100%;
      max-width: 500px;
      border: 2px solid #0056b3;
    }

    #faceCanvas {
      display: none;
    }

    .status-info {
      background-color: #e3f2fd;
      border-left: 4px solid #0056b3;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 15px;
    }

    .alert-warning {
      background-color: #fff3cd;
      border-color: #ffeaa7;
      color: #856404;
    }

    .file-upload {
      border: 2px dashed #0056b3;
      border-radius: 5px;
      padding: 15px;
      text-align: center;
      background-color: #f8f9fa;
      cursor: pointer;
    }

    .file-upload:hover {
      background-color: #e3f2fd;
    }

    .face-recognition-status {
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      text-align: center;
      font-weight: bold;
    }

    .status-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status-warning {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .status-danger {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .detection-box {
      position: absolute;
      border: 2px solid #00ff00;
      background: transparent;
    }

    .training-section {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 5px;
      padding: 15px;
      margin-top: 15px;
    }

    .training-photo {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border: 2px solid #28a745;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg" style="background-color: #0056b3;">
    <div class="container-fluid">
      <a class="navbar-brand text-white" href="#">
        <i class="fas fa-school me-2"></i>MTs Nurul Huda
      </a>
      <div class="navbar-nav ms-auto">
        <a class="nav-link text-white" href="{{ url_for('dashboard') }}">
          <i class="fas fa-tachometer-alt me-1"></i>Dashboard
        </a>
        <a class="nav-link text-white" href="{{ url_for('riwayat') }}">
          <i class="fas fa-history me-1"></i>Riwayat
        </a>
        <a class="nav-link text-warning" href="{{ url_for('logout') }}">
          <i class="fas fa-sign-out-alt me-1"></i>Logout
        </a>
      </div>
    </div>
  </nav>

  <div class="container">
    <h3><i class="fas fa-calendar-day me-2"></i>Presensi Hari Ini ({{ tanggal }})</h3>

    <!-- Status Presensi Hari Ini -->
    {% if sudah_absen %}
    <div class="alert alert-info">
      <h5><i class="fas fa-check-circle me-2"></i>Anda sudah melakukan presensi hari ini</h5>
      <p class="mb-1"><strong>Waktu Masuk:</strong> {{ presensi_hari_ini.waktu_masuk or '-' }}</p>
      <p class="mb-1"><strong>Status:</strong> {{ presensi_hari_ini.status or '-' }}</p>
      {% if presensi_hari_ini.keterangan %}
      <p class="mb-0"><strong>Keterangan:</strong> {{ presensi_hari_ini.keterangan }}</p>
      {% endif %}
    </div>
    {% endif %}

    <!-- Info Radius GPS -->
    <div class="status-info">
      <h6><i class="fas fa-info-circle me-2"></i>Informasi Presensi</h6>
      <p class="mb-1">‚Ä¢ Presensi hanya bisa dilakukan dalam radius <strong>100 meter</strong> dari sekolah</p>
      <p class="mb-1">‚Ä¢ Wajah akan diverifikasi secara otomatis menggunakan Face Recognition</p>
      <p class="mb-1">‚Ä¢ Pastikan wajah terlihat jelas dengan pencahayaan yang baik</p>
      <p class="mb-0">‚Ä¢ Waktu masuk dan keluar terisi otomatis</p>
    </div>

    <form method="POST" enctype="multipart/form-data" id="presensiForm">
      <!-- Waktu Masuk & Keluar Otomatis -->
      <div class="row mb-3">
        <div class="col-md-6">
          <label for="waktu_masuk" class="form-label">
            <i class="fas fa-sign-in-alt me-1"></i>Waktu Masuk
          </label>
          <input type="time" class="form-control" id="waktu_masuk" name="waktu_masuk" readonly>
        </div>
        <div class="col-md-6">
          <label for="waktu_keluar" class="form-label">
            <i class="fas fa-sign-out-alt me-1"></i>Waktu Keluar
          </label>
          <input type="time" class="form-control" id="waktu_keluar" name="waktu_keluar" readonly>
        </div>
      </div>

      <div class="mb-3">
        <label for="status" class="form-label">
          <i class="fas fa-user-check me-1"></i>Status *
        </label>
        <select class="form-select" id="status" name="status" required onchange="toggleSuratUpload()">
          <option value="">-- Pilih Status --</option>
          <option value="Hadir">Hadir</option>
          <option value="Sakit">Sakit</option>
          <option value="Izin">Izin</option>
          <option value="Alpha">Alpha</option>
        </select>
      </div>

      <!-- Upload Surat (muncul hanya untuk Izin/Sakit) -->
      <div class="mb-3" id="suratUpload" style="display: none;">
        <label for="surat" class="form-label">
          <i class="fas fa-file-upload me-1"></i>Upload Surat Izin/Sakit *
        </label>
        <div class="file-upload" onclick="document.getElementById('surat').click()">
          <i class="fas fa-upload me-2"></i>Klik untuk upload surat
          <input type="file" class="form-control d-none" id="surat" name="surat" accept=".pdf,.jpg,.jpeg,.png">
        </div>
        <small class="text-muted">Format: PDF, JPG, PNG (maks. 2MB)</small>
        <div id="fileName" class="mt-2"></div>
      </div>

      <div class="mb-3">
        <label for="keterangan" class="form-label">
          <i class="fas fa-sticky-note me-1"></i>Keterangan
        </label>
        <input type="text" class="form-control" id="keterangan" name="keterangan" placeholder="Opsional (contoh: rapat, dinas luar, dll)">
      </div>

      <!-- Lokasi GPS -->
      <div class="card mb-3">
        <div class="card-header">
          <i class="fas fa-map-marker-alt me-2"></i>Lokasi GPS
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <label class="form-label">Latitude</label>
              <input type="text" class="form-control" id="latitude" name="latitude" placeholder="Latitude" readonly>
            </div>
            <div class="col-md-6">
              <label class="form-label">Longitude</label>
              <input type="text" class="form-control" id="longitude" name="longitude" placeholder="Longitude" readonly>
            </div>
          </div>
          <div id="locationStatus" class="mt-2"></div>
        </div>
      </div>

      <!-- Face Recognition -->
      <div class="card mb-3">
        <div class="card-header">
          <i class="fas fa-camera me-2"></i>Verifikasi Wajah
          {% if is_trained %}
            <span class="badge bg-success ms-2"><i class="fas fa-check me-1"></i>Trained</span>
          {% else %}
            <span class="badge bg-warning ms-2"><i class="fas fa-exclamation-triangle me-1"></i>Perlu Training</span>
          {% endif %}
        </div>
        <div class="card-body">
          <div id="faceRecognitionStatus" class="face-recognition-status status-warning">
            <i class="fas fa-spinner fa-spin me-2"></i>Memuat sistem face recognition...
          </div>

          <div class="row">
            <div class="col-md-6">
              <div style="position: relative;">
                <video id="video" autoplay muted></video>
                <canvas id="faceCanvas"></canvas>
              </div>
              <div class="text-center mt-2">
                <small class="text-muted">Pastikan wajah terlihat jelas di area kotak deteksi</small>
              </div>
            </div>
            <div class="col-md-6">
              <div id="verificationResult" class="text-center">
                <p class="text-muted"><i class="fas fa-info-circle me-2"></i>Wajah akan terdeteksi otomatis setelah kamera dinyalakan</p>
                <div id="confidenceLevel" class="mt-3"></div>
              </div>
            </div>
          </div>

          <div class="mt-3">
            <button type="button" class="btn btn-primary" id="startCamera" disabled>
              <i class="fas fa-camera me-2"></i>Mulai Kamera
            </button>
            <button type="button" class="btn btn-outline-secondary" id="stopCamera" style="display: none;">
              <i class="fas fa-stop me-2"></i>Hentikan Kamera
            </button>
            {% if not is_trained %}
            <button type="button" class="btn btn-info ms-2" id="startTraining" disabled>
              <i class="fas fa-brain me-2"></i>Training Wajah
            </button>
            {% endif %}
          </div>

          <!-- Training Section -->
          <div id="trainingSection" class="training-section" style="display: none;">
            <h6><i class="fas fa-graduation-cap me-2"></i>Training Wajah</h6>
            <p class="mb-2">Ambil 5 foto wajah dari berbagai angle untuk training sistem:</p>
            <div id="trainingPhotos" class="row mb-3"></div>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-success" id="saveTraining" disabled>
                <i class="fas fa-save me-2"></i>Simpan Training
              </button>
              <button type="button" class="btn btn-outline-secondary" id="cancelTraining">
                <i class="fas fa-times me-2"></i>Batal
              </button>
            </div>
          </div>

          <input type="hidden" name="face_detected" id="face_detected" value="false">
          <input type="hidden" name="face_confidence" id="face_confidence" value="0">
          <input type="hidden" name="image_data" id="image_data">
        </div>
      </div>

      <!-- Submit Button -->
      {% if not sudah_absen %}
      <button type="submit" class="btn btn-success btn-lg" id="submitBtn" disabled>
        <i class="fas fa-check-circle me-2"></i>Submit Presensi
      </button>
      {% else %}
      <button type="button" class="btn btn-secondary btn-lg" disabled>
        <i class="fas fa-check me-2"></i>Sudah Absen Hari Ini
      </button>
      {% endif %}
      <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Kembali ke Dashboard
      </a>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ===== VARIABLES =====
    let faceDetectionInterval;
    let isCameraOn = false;
    let modelsLoaded = false;
    let faceDescriptors = [];
    let isTrained = {{ 'true' if is_trained else 'false' }};
    let trainingInterval;

    // ===== INITIALIZATION =====
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Initializing Presensi System...');
      setWaktuOtomatis();
      getLocation();
      loadFaceAPIModels();
    });

    // ===== BASIC FUNCTIONS =====
    function setWaktuOtomatis() {
      const now = new Date();
      const waktuMasuk = document.getElementById('waktu_masuk');
      const waktuKeluar = document.getElementById('waktu_keluar');

      const formatWaktu = (date) => date.toTimeString().slice(0, 5);

      if (!waktuMasuk.value) {
        waktuMasuk.value = formatWaktu(now);
      }

      setInterval(() => {
        waktuKeluar.value = formatWaktu(new Date());
      }, 1000);
    }

    function toggleSuratUpload() {
      const status = document.getElementById('status').value;
      const suratUpload = document.getElementById('suratUpload');
      const suratInput = document.getElementById('surat');

      if (status === 'Izin' || status === 'Sakit') {
        suratUpload.style.display = 'block';
        suratInput.required = true;
      } else {
        suratUpload.style.display = 'none';
        suratInput.required = false;
      }
    }

    document.getElementById('surat').addEventListener('change', function(e) {
      const fileName = document.getElementById('fileName');
      if (this.files.length > 0) {
        fileName.innerHTML = `<span class="text-success"><i class="fas fa-file me-1"></i>File terpilih: ${this.files[0].name}</span>`;
      } else {
        fileName.innerHTML = '';
      }
    });

    // ===== FACE RECOGNITION SYSTEM =====
    async function loadFaceAPIModels() {
      try {
        updateFaceRecognitionStatus('<i class="fas fa-spinner fa-spin me-2"></i>Memuat model AI...', 'status-warning');

        // Coba dari CDN dulu (lebih reliable)
        const MODEL_URL = 'https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights/';

        console.log('üì• Loading Face-API.js models from CDN...');
        await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
        console.log('‚úÖ Tiny Face Detector loaded');

        await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
        console.log('‚úÖ Face Landmark loaded');

        await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
        console.log('‚úÖ Face Recognition loaded');

        modelsLoaded = true;
        console.log('üéâ All Face-API.js models loaded successfully!');

        // Enable buttons
        document.getElementById('startCamera').disabled = false;
        if (document.getElementById('startTraining')) {
          document.getElementById('startTraining').disabled = false;
        }

        if (isTrained) {
          updateFaceRecognitionStatus('<i class="fas fa-check-circle me-2"></i>Model siap - Silakan mulai kamera', 'status-success');
        } else {
          updateFaceRecognitionStatus('<i class="fas fa-check-circle me-2"></i>Model siap - Silakan training wajah', 'status-warning');
        }

      } catch (error) {
        console.error('‚ùå Error loading models:', error);
        handleModelsLoadFailure();
      }
    }

    function handleModelsLoadFailure() {
      updateFaceRecognitionStatus('<i class="fas fa-exclamation-triangle me-2"></i>Model AI tidak tersedia', 'status-danger');

      // Tetap enable buttons untuk fallback mode
      document.getElementById('startCamera').disabled = false;
      if (document.getElementById('startTraining')) {
        document.getElementById('startTraining').disabled = false;
      }

      modelsLoaded = true; // Tetap anggap loaded untuk fallback
    }

    function updateFaceRecognitionStatus(message, statusClass) {
      const statusElement = document.getElementById('faceRecognitionStatus');
      statusElement.innerHTML = message;
      statusElement.className = `face-recognition-status ${statusClass}`;
    }

    async function startFaceDetection() {
      if (!modelsLoaded) {
        updateFaceRecognitionStatus('<i class="fas fa-exclamation-triangle me-2"></i>Model AI belum siap', 'status-danger');
        return;
      }

      if (!isTrained) {
        updateFaceRecognitionStatus('<i class="fas fa-exclamation-triangle me-2"></i>Silakan training wajah terlebih dahulu', 'status-danger');
        return;
      }

      const video = document.getElementById('video');
      const canvas = document.getElementById('faceCanvas');

      try {
        updateFaceRecognitionStatus('<i class="fas fa-camera me-2"></i>Mengakses kamera...', 'status-warning');

        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            width: 640, 
            height: 480,
            facingMode: 'user'
          } 
        });

        video.srcObject = stream;
        isCameraOn = true;

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        // Update UI
        document.getElementById('stopCamera').style.display = 'inline-block';
        document.getElementById('startCamera').style.display = 'none';

        updateFaceRecognitionStatus('<i class="fas fa-search me-2"></i>Kamera aktif - Verifikasi wajah...', 'status-warning');

        // Start face detection loop
        faceDetectionInterval = setInterval(async () => {
          if (!isCameraOn) return;

          try {
            const detections = await faceapi
              .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
              .withFaceLandmarks()
              .withFaceDescriptors();

            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw detections
            faceapi.draw.drawDetections(canvas, detections);
            faceapi.draw.drawFaceLandmarks(canvas, detections);

            if (detections.length > 0) {
              const detection = detections[0];
              const currentDescriptor = Array.from(detection.descriptor);

              // Face matching dengan backend
              const verifyResponse = await fetch('/api/face/verify', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({descriptor: currentDescriptor})
              });

              const verifyResult = await verifyResponse.json();

              if (verifyResult.success && verifyResult.verified) {
                handleFaceVerified(verifyResult, detection, video);
              } else {
                handleFaceNotVerified();
              }
            } else {
              handleNoFaceDetected();
            }
          } catch (error) {
            console.error('Detection error:', error);
            handleFaceDetectionFallback(video);
          }
        }, 1000);

      } catch (error) {
        console.error('‚ùå Error accessing camera:', error);
        updateFaceRecognitionStatus('<i class="fas fa-video-slash me-2"></i>Tidak dapat mengakses kamera', 'status-danger');
        alert('Error kamera: ' + error.message + '\n\nPastikan:\n‚Ä¢ Kamera tidak sedang digunakan\n‚Ä¢ Izin kamera sudah diberikan\n‚Ä¢ Browser mendukung WebRTC');
      }
    }

    function handleFaceVerified(verifyResult, detection, video) {
      document.getElementById('face_detected').value = 'true';
      document.getElementById('face_confidence').value = verifyResult.confidence;

      document.getElementById('confidenceLevel').innerHTML = `
        <div class="alert alert-success">
          <h6><i class="fas fa-check-circle me-2"></i>Wajah Dikenali!</h6>
          <p class="mb-1">Confidence: <strong>${(verifyResult.confidence * 100).toFixed(1)}%</strong></p>
          <p class="mb-0"><small>Distance: ${verifyResult.distance}</small></p>
        </div>
      `;

      updateFaceRecognitionStatus('<i class="fas fa-check-circle me-2"></i>Wajah dikenali - Siap presensi!', 'status-success');
      document.getElementById('submitBtn').disabled = false;

      // Capture image for submission
      captureFaceImage(video);
    }

    function handleFaceNotVerified() {
      document.getElementById('face_detected').value = 'false';
      document.getElementById('confidenceLevel').innerHTML = `
        <div class="alert alert-danger">
          <h6><i class="fas fa-times-circle me-2"></i>Wajah Tidak Dikenali</h6>
          <p class="mb-0">Pastikan ini adalah wajah Anda</p>
        </div>
      `;
      updateFaceRecognitionStatus('<i class="fas fa-times-circle me-2"></i>Wajah tidak dikenali', 'status-danger');
      document.getElementById('submitBtn').disabled = true;
    }

    function handleNoFaceDetected() {
      document.getElementById('face_detected').value = 'false';
      document.getElementById('face_confidence').value = '0';
      updateFaceRecognitionStatus('<i class="fas fa-user me-2"></i>Arahkan wajah ke kamera...', 'status-warning');
      document.getElementById('submitBtn').disabled = true;
      document.getElementById('confidenceLevel').innerHTML = '';
    }

    function handleFaceDetectionFallback(video) {
      // Simple fallback detection
      document.getElementById('face_detected').value = 'true';
      document.getElementById('face_confidence').value = '0.9';

      document.getElementById('confidenceLevel').innerHTML = `
        <div class="alert alert-info">
          <h6><i class="fas fa-info-circle me-2"></i>Wajah Terdeteksi</h6>
          <p class="mb-0">Mode fallback aktif</p>
        </div>
      `;

      updateFaceRecognitionStatus('<i class="fas fa-check-circle me-2"></i>Wajah terdeteksi - Siap presensi!', 'status-success');
      document.getElementById('submitBtn').disabled = false;

      captureFaceImage(video);
    }

    function captureFaceImage(video) {
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = video.videoWidth;
      tempCanvas.height = video.videoHeight;
      tempCanvas.getContext('2d').drawImage(video, 0, 0);
      document.getElementById('image_data').value = tempCanvas.toDataURL('image/jpeg');
    }

    // ===== TRAINING SYSTEM =====
    async function startTraining() {
      if (!modelsLoaded) {
        alert('Model AI belum siap! Tunggu sampai status "Model siap".');
        return;
      }

      try {
        await startCameraForTraining();

        document.getElementById('startTraining').style.display = 'none';
        document.getElementById('trainingSection').style.display = 'block';
        faceDescriptors = [];

        updateFaceRecognitionStatus('<i class="fas fa-camera me-2"></i>Training - Ambil foto wajah...', 'status-warning');

        let captureCount = 0;
        trainingInterval = setInterval(async () => {
          if (captureCount >= 5) {
            clearInterval(trainingInterval);
            document.getElementById('saveTraining').disabled = false;
            updateFaceRecognitionStatus('<i class="fas fa-check-circle me-2"></i>Training selesai - Klik Simpan', 'status-success');
            return;
          }

          try {
            const detections = await faceapi
              .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
              .withFaceLandmarks()
              .withFaceDescriptors();

            if (detections.length === 1) {
              const descriptor = Array.from(detections[0].descriptor);
              faceDescriptors.push(descriptor);
              captureCount++;

              // Show captured photo
              const canvas = document.createElement('canvas');
              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;
              canvas.getContext('2d').drawImage(video, 0, 0);

              document.getElementById('trainingPhotos').innerHTML += `
                <div class="col-2 text-center">
                  <img src="${canvas.toDataURL('image/jpeg')}" class="training-photo img-thumbnail">
                  <div><small>#${captureCount}</small></div>
                </div>
              `;

              updateFaceRecognitionStatus(`<i class="fas fa-camera me-2"></i>Training - Foto ${captureCount}/5 diambil`, 'status-warning');
            }
          } catch (error) {
            console.error('Training capture error:', error);
          }
        }, 2000);

      } catch (error) {
        alert('Error memulai training: ' + error.message);
      }
    }

    async function startCameraForTraining() {
      const video = document.getElementById('video');
      const canvas = document.getElementById('faceCanvas');

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            width: 640, 
            height: 480,
            facingMode: 'user'
          } 
        });

        video.srcObject = stream;
        isCameraOn = true;

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        document.getElementById('stopCamera').style.display = 'inline-block';
        document.getElementById('startCamera').style.display = 'none';

      } catch (error) {
        console.error('Error accessing camera:', error);
        updateFaceRecognitionStatus('<i class="fas fa-video-slash me-2"></i>Tidak dapat mengakses kamera', 'status-danger');
        throw error;
      }
    }

    async function saveTraining() {
      try {
        const response = await fetch('/api/face/train', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({descriptors: faceDescriptors})
        });

        const result = await response.json();

        if (result.success) {
          updateFaceRecognitionStatus('<i class="fas fa-check-circle me-2"></i>Training berhasil! Siap untuk presensi', 'status-success');
          document.getElementById('trainingSection').style.display = 'none';
          document.getElementById('startTraining').style.display = 'none';

          // Refresh page
          setTimeout(() => {
            window.location.reload();
          }, 2000);
        } else {
          alert('Error: ' + result.message);
        }
      } catch (error) {
        console.error('Error saving training:', error);
        alert('Error menyimpan training: ' + error.message);
      }
    }

    function cancelTraining() {
      if (trainingInterval) {
        clearInterval(trainingInterval);
      }
      document.getElementById('trainingSection').style.display = 'none';
      document.getElementById('startTraining').style.display = 'inline-block';
      stopFaceDetection();
    }

    function stopFaceDetection() {
      if (faceDetectionInterval) clearInterval(faceDetectionInterval);
      if (trainingInterval) clearInterval(trainingInterval);

      const video = document.getElementById('video');
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
        video.srcObject = null;
      }

      isCameraOn = false;
      document.getElementById('startCamera').style.display = 'inline-block';
      document.getElementById('stopCamera').style.display = 'none';
      updateFaceRecognitionStatus('<i class="fas fa-camera me-2"></i>Kamera dihentikan', 'status-warning');
      document.getElementById('submitBtn').disabled = true;
    }

    // ===== GEOLOCATION =====
    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;

            const schoolLat = -6.2088;
            const schoolLng = 106.8456;

            const distance = calculateDistance(lat, lng, schoolLat, schoolLng);
            const locationStatus = document.getElementById('locationStatus');
            const submitBtn = document.getElementById('submitBtn');

            if (distance <= 100) {
              locationStatus.innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-1"></i>Dalam radius (${distance.toFixed(0)} meter dari sekolah)</span>`;
            } else {
              locationStatus.innerHTML = `<span class="text-danger"><i class="fas fa-times-circle me-1"></i>Diluar radius (${distance.toFixed(0)} meter dari sekolah)</span>`;
              if (submitBtn) submitBtn.disabled = true;
            }
          },
          function(error) {
            document.getElementById('locationStatus').innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Gagal mendapatkan lokasi</span>';
          }
        );
      }
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // ===== EVENT LISTENERS =====
    document.getElementById('startCamera').addEventListener('click', startFaceDetection);
    document.getElementById('stopCamera').addEventListener('click', stopFaceDetection);

    {% if not is_trained %}
    document.getElementById('startTraining').addEventListener('click', startTraining);
    {% endif %}

    document.getElementById('saveTraining').addEventListener('click', saveTraining);
    document.getElementById('cancelTraining').addEventListener('click', cancelTraining);
  </script>
</body>
</html>
